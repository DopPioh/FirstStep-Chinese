<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>โปรไฟล์ผู้ใช้ - FirstStep Chinese</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="icon" type="image/png" href="/img/logo/1.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/menu.css">
</head>
<body class="bg-light">
    <header class="navbar navbar-expand-lg navbar-dark bg-danger sticky-top shadow-sm">
        <div class="container fs-5">
            <a href="/" class="navbar-brand d-flex align-items-center gap-2">
                <img src="/img/logo/1.png" class="logo rounded-4 shadow-sm" alt="Logo" width="60">
                <span class="fw-bold fs-3">FirstStep Chinese</span>
            </a>
        </div>
    </header>
    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="profile-card card border-0 rounded-4 shadow-lg p-4 mb-5">
                    <div class="text-center mb-3">
                        <img id="profileAvatar" class="profile-avatar-img" src="/img/profile/default.png" alt="โปรไฟล์">
                        <div>
                            <button class="btn btn-outline-secondary btn-sm mt-2 rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#avatarModal">
                                <i class="bi bi-camera"></i> เปลี่ยนรูปโปรไฟล์
                            </button>
                        </div>
                    </div>
                    <h2 class="mb-4 text-center text-danger fw-bold">โปรไฟล์ผู้ใช้</h2>
                    <ul class="list-group list-group-flush fs-5 mb-2">
                        <li class="list-group-item bg-transparent border-0 py-2">
                            <span class="profile-label">ชื่อ:</span>
                            <span id="profileName" class="profile-value"></span>
                        </li>
                        <li class="list-group-item bg-transparent border-0 py-2">
                            <span class="profile-label">อีเมล:</span>
                            <span id="profileEmail" class="profile-value"></span>
                        </li>
                        <li class="list-group-item bg-transparent border-0 py-2">
                            <span class="profile-label">เบอร์โทรศัพท์:</span>
                            <span id="profilePhone" class="profile-value"></span>
                        </li>
                        <li class="list-group-item bg-transparent border-0 py-2">
                            <span class="profile-label">ID Line:</span>
                            <span id="profileLine" class="profile-value"></span>
                        </li>
                    </ul>
                    <button class="btn btn-outline-danger rounded-pill w-100 mt-4 shadow-sm" onclick="editProfile()">แก้ไขข้อมูล</button>
                </div>
            </div>
        </div>
    </main>
    <!-- Avatar Modal -->
    <div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-2">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-circle"></i> เลือกรูปโปรไฟล์</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3 mb-2">
              <!-- รูปตัวอย่างที่มีให้เลือก -->
              <div class="col-4 text-center">
                <img src="/img/profile/panda.png" class="profile-avatar-select" alt="Default" onclick="selectAvatar(event)">
                <div class="small mt-1">panda</div>
              </div>
              <div class="col-4 text-center">
                <img src="/img/profile/boy.png" class="profile-avatar-select" alt="Avatar 1" onclick="selectAvatar(event)">
                <div class="small mt-1">ผู้ชาย</div>
              </div>
              <div class="col-4 text-center">
                <img src="/img/profile/girl.png" class="profile-avatar-select" alt="Avatar 2" onclick="selectAvatar(event)">
                <div class="small mt-1">ผู้หญิง</div>
              </div>
              <!-- เพิ่มรูปอื่นๆ ตามต้องการ -->
            </div>
            <hr>
            <div>
              <label class="form-label">หรืออัปโหลดรูปของคุณเอง</label>
              <input type="file" class="form-control" id="uploadAvatarInput" accept="image/*">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">เสร็จสิ้น</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="editProfileForm">
          <div class="modal-header">
            <h5 class="modal-title">แก้ไขโปรไฟล์</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">ชื่อ</label>
              <input type="text" class="form-control" id="editName" required>
            </div>
            <div class="mb-2">
              <label class="form-label">อีเมล</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            <div class="mb-2">
              <label class="form-label">เบอร์โทรศัพท์</label>
              <input type="tel" class="form-control" id="editPhone" required>
            </div>
            <div class="mb-2">
              <label class="form-label">ID Line</label>
              <input type="text" class="form-control" id="editLineId">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-danger">บันทึก</button>
          </div>
        </form>
      </div>
    </div>
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 px-4 bg-danger text-white border-top mt-5 shadow-lg">
        <div class="col-md-6 d-flex align-items-center">
            <a href="/" class="mb-3 me-2 mb-md-0 text-white text-decoration-none lh-1">
                <img src="/img/logo/1.png" width="55" height="55" alt="Logo" class="rounded-3">
            </a>
            <span class="mb-3 mb-md-1 fs-5">&copy; 2025 FirstStep Chinese</span>
        </div>
        <ul class="nav col-md-4 justify-content-end list-unstyled d-flex mx-auto">
            <li class="ms-3"><a class="text-white" href="#"><i class="bi bi-twitter fs-3"></i></a></li>
            <li class="ms-3"><a class="text-white" href="#"><i class="bi bi-instagram fs-3"></i></a></li>
            <li class="ms-3"><a class="text-white" href="#"><i class="bi bi-facebook fs-3"></i></a></li>
        </ul>
    </footer>
    <script src="/js/bootstrap.min.js"></script>
    <script>
        // ดึงข้อมูลโปรไฟล์ (localStorage หรือ API)
        document.getElementById('profileName').textContent = localStorage.getItem('name') || '-';
        document.getElementById('profileEmail').textContent = localStorage.getItem('email') || '-';
        document.getElementById('profilePhone').textContent = localStorage.getItem('phone') || '-';
        document.getElementById('profileLine').textContent = localStorage.getItem('lineId') || '-';

        // รูปโปรไฟล์ (ใช้ localStorage จำ path หรือ base64)
        const profileAvatar = document.getElementById('profileAvatar');
        const savedAvatar = localStorage.getItem('profileAvatar');
        if (savedAvatar) profileAvatar.src = savedAvatar;

        // เลือกรูปโปรไฟล์ที่มีให้
        function selectAvatar(e) {
            document.querySelectorAll('.profile-avatar-select').forEach(img => img.classList.remove('selected'));
            e.target.classList.add('selected');
            profileAvatar.src = e.target.src;
            localStorage.setItem('profileAvatar', e.target.src);
        }
        // อัปโหลดรูปโปรไฟล์เอง
        document.getElementById('uploadAvatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    profileAvatar.src = evt.target.result;
                    localStorage.setItem('profileAvatar', evt.target.result);
                    document.querySelectorAll('.profile-avatar-select').forEach(img => img.classList.remove('selected'));
                };
                reader.readAsDataURL(file);
            }
        });

        function editProfile() {
            // แสดงข้อมูลปัจจุบันในฟอร์มแก้ไข
            document.getElementById('editName').value = localStorage.getItem('name') || '';
            document.getElementById('editEmail').value = localStorage.getItem('email') || '';
            document.getElementById('editPhone').value = localStorage.getItem('phone') || '';
            document.getElementById('editLineId').value = localStorage.getItem('lineId') || '';

            // แสดงโมดัลแก้ไขโปรไฟล์
            var myModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            myModal.show();
        }

        // บันทึกการแก้ไขโปรไฟล์
        document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const lineId = document.getElementById('editLineId').value;
            const token = localStorage.getItem('token');
            const res = await fetch('/api/auth/update-profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ name, email, phone, lineId })
            });
            const data = await res.json();
            if (res.ok) {
                // อัปเดต localStorage
                localStorage.setItem('name', data.name);
                localStorage.setItem('email', data.email);
                localStorage.setItem('phone', data.phone);
                localStorage.setItem('lineId', data.lineId);

                // อัปเดตข้อมูลในหน้าโปรไฟล์
                document.getElementById('profileName').textContent = data.name;
                document.getElementById('profileEmail').textContent = data.email;
                document.getElementById('profilePhone').textContent = data.phone;
                document.getElementById('profileLine').textContent = data.lineId;

                // ปิด modal
                var myModal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                myModal.hide();
            } else {
                alert(data.message || 'เกิดข้อผิดพลาด');
            }
        });
    </script>
</body>
</html>
